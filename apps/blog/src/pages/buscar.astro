---
export const prerender = false;

import BaseLayout from "../layouts/BaseLayout.astro";
import PostCard from "../components/PostCard.astro";
import { searchPosts } from "../services/api";

const q = Astro.url.searchParams.get("q") ?? "";
const page = Number(Astro.url.searchParams.get("page") ?? "1");
const PAGE_SIZE = 12;

const data = q.trim() ? await searchPosts(q, { limit: PAGE_SIZE, page }) : null;

function urlFor(p) {
  const params = new URLSearchParams();
  params.set("q", q);
  params.set("page", String(p));
  return `/buscar?${params.toString()}`;
}
---

<BaseLayout title={q ? `Buscar: ${q}` : "Buscar"}>
  <h1>Buscar</h1>

  <form method="get" action="/buscar" class="search">
    <input name="q" value={q} placeholder="Digite um termo" />
    <button class="btn" type="submit">Buscar</button>
  </form>

  {q && data && (
    <>
      <p>{data.totalDocs} resultados</p>

      <section class="grid">
        {data.docs.map((post) => <PostCard post={post} />)}
      </section>

      {data.totalPages > 1 && (
        <nav class="pagination" aria-label="Paginação da busca">
          {page > 1 && <a class="btn" href={urlFor(page - 1)}>Anterior</a>}
          <span>Página {page} de {data.totalPages}</span>
          {page < data.totalPages && <a class="btn" href={urlFor(page + 1)}>Próxima</a>}
        </nav>
      )}
    </>
  )}
</BaseLayout>