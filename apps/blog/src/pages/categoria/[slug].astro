---
import BaseLayout from "../../layouts/BaseLayout.astro";
import PostCard from "../../components/PostCard.astro";
import { getCategoryBySlug, getPostsByCategorySlugPaged } from "../../services/api";

export const prerender = false;

const { slug } = Astro.params;
if (!slug) throw new Error("Missing category slug");

const page = Number(Astro.url.searchParams.get("page") ?? "1");
const PAGE_SIZE = 12;

const category = await getCategoryBySlug(slug);

// Se não achou categoria, devolve um estado consistente
const data = category
  ? await getPostsByCategorySlugPaged(slug, { limit: PAGE_SIZE, page, sort: "-createdAt" })
  : { docs: [], totalDocs: 0, limit: PAGE_SIZE, page, totalPages: 1 };

function urlFor(p: number) {
  const params = new URLSearchParams();
  params.set("page", String(p));
  return `/categoria/${slug}?${params.toString()}`;
}

const title = category?.title ? `Categoria: ${category.title}` : "Categoria";
const description = category?.title
  ? `Posts da categoria "${category.title}".`
  : "Categoria não encontrada.";
---

<BaseLayout title={title} description={description}>
  {!category ? (
    <section class="prose">
      <h1>Categoria não encontrada</h1>
      <p>Essa categoria não existe ou não está disponível.</p>
      <a class="ds-btn ds-btn-outline" href="/posts">Ver todos os posts</a>
    </section>
  ) : (
    <>
      <div style="margin: 0 0 18px 0;">
        <h1 style="margin: 0 0 6px 0;">{category.title}</h1>
        {category?.slug ? (
          <p class="ds-muted" style="margin:0;">/categoria/{category.slug}</p>
        ) : null}
      </div>

      {data.totalDocs === 0 ? (
        <div class="ds-card" style="padding: 16px;">
          <p style="margin:0;">Nenhum post encontrado nesta categoria.</p>
        </div>
      ) : (
        <>
          <p class="ds-muted" style="margin: 0 0 14px 0;">{data.totalDocs} posts</p>

          <section class="grid" style="display:grid; gap: 14px;">
            {data.docs.map((post) => <PostCard post={post} />)}
          </section>

          {data.totalPages > 1 && (
            <nav style="display:flex; gap: 10px; align-items:center; margin-top: 18px;" aria-label="Paginação da categoria">
              {data.page > 1 && <a class="ds-btn ds-btn-outline" href={urlFor(data.page - 1)}>Anterior</a>}
              <span class="ds-muted">Página {data.page} de {data.totalPages}</span>
              {data.page < data.totalPages && <a class="ds-btn ds-btn-outline" href={urlFor(data.page + 1)}>Próxima</a>}
            </nav>
          )}
        </>
      )}
    </>
  )}
</BaseLayout>