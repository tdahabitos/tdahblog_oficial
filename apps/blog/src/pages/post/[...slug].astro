---
import PostLayout from "../../layouts/PostLayout.astro";
import TOC from "../../components/TOC.astro";
import Breadcrumbs from "../../components/nav/Breadcrumbs.astro";
import ShareBar from "../../components/blocks/ShareBar.astro";
import NewsletterBox from "../../components/blocks/NewsletterBox.astro";
import CTABox from "../../components/blocks/CTABox.astro";
import LikeButton from "../../components/LikeButton.astro";
import CommentBox from "../../components/CommentBox.astro";

import SchemaArticle from "../../components/SchemaArticle.astro";
import SchemaBreadcrumbs from "../../components/SchemaBreadcrumbs.astro";

import { getPosts, getPostBySlug } from "../../services/api";
import { buildTocFromHtml } from "../../lib/toc";

export async function getStaticPaths() {
  try {
    const posts = await getPosts({ limit: 200, page: 1, sort: "-createdAt" });
    return posts
      .filter((p) => p?.slug)
      .map((p) => ({ params: { slug: p.slug } }));
  } catch {
    return [];
  }
}

const raw = Astro.params.slug;
const slug = decodeURIComponent(Array.isArray(raw) ? raw.join("/") : (raw ?? ""));
const post = slug ? await getPostBySlug(slug) : null;

// TOC
let toc: any[] = [];
let html: string | null = null;

if (post) {
  const candidate =
    typeof (post as any).contentHtml === "string"
      ? (post as any).contentHtml
      : typeof post.content === "string"
        ? (post.content as string)
        : null;

  if (candidate && candidate.includes("<h")) {
    const r = buildTocFromHtml(candidate);
    html = r.html;
    toc = r.toc;
  } else {
    html = candidate;
  }
}

// SEO helpers
const canonical = Astro.site
  ? new URL(Astro.url.pathname, Astro.site).toString()
  : Astro.url.toString();

const crumbs = [
  {
    name: "Comece aqui",
    item: Astro.site ? new URL("/comece-aqui", Astro.site).toString() : "/comece-aqui",
  },
  { name: post?.title ?? "Post", item: canonical },
];

// Para UI de likes/comentários: sempre usa um slug válido
const postSlug = (post as any)?.slug ? String((post as any).slug) : slug;
---

<PostLayout
  title={post?.title ?? "Post não encontrado"}
  description={post?.description ?? "Conteúdo não disponível."}
  cover={post?.cover}
  canonical={canonical}
>
  {!post ? (
    <article class="prose">
      <h1>Post não encontrado</h1>
      <p>Esse conteúdo não está disponível.</p>
    </article>
  ) : (
    <>
      <SchemaBreadcrumbs items={crumbs} />
      <SchemaArticle
        title={post.title}
        description={post.description}
        url={canonical}
        image={post.cover?.url}
        datePublished={post.createdAt}
        dateModified={post.updatedAt}
      />

      <Breadcrumbs items={crumbs} />

      <div class="post-grid">
        <TOC items={toc} />
        <article class="prose">
          {html ? <Fragment set:html={html} /> : post.content}
        </article>
      </div>

      <ShareBar />

      <!-- Interações (Parte 8) -->
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <LikeButton slug={postSlug} />
      </div>
      <CommentBox slug={postSlug} />

      <CTABox />
      <NewsletterBox />
    </>
  )}
</PostLayout>



